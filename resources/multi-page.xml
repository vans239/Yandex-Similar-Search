<config>
    <include path="copies.xml"/>
    <!--Download multi-page list of items. @param pageUrl - URL of starting page @param itemXPath - XPath expression to obtain single item in the list @param nextXPath - XPath expression to URL for the next page @param maxloops - maximum number of pages downloaded @return list of all downloaded items-->
    <function name="download-multipage-list">
        <return>
            <while condition="${pageUrl.toString().length() != 0}" maxloops="${maxloops}" index="i">
                <empty>
                    <var-def name="content">
                        <html-to-xml>
                            <http url="${pageUrl}"/>
                        </html-to-xml>
                    </var-def>
                    <var-def name="nextLinkUrl">
                        <xpath expression="${nextXPath}">
                            <var name="content"/>
                        </xpath>
                    </var-def>
                    <var-def name="clusterUrl">
                        <xpath expression="${copiesXPath}">
                            <var name="content"/>
                        </xpath>
                    </var-def>
                    <var-def name="pageUrl">
                        <template>${sys.fullUrl(pageUrl.toString(), nextLinkUrl.toString())}</template>
                    </var-def>
                </empty>
                <xpath expression="${itemXPath}">
                    <var name="content"/>
                </xpath>
                <loop index="i" item="url">
                    <list>
                        <var name="clusterUrl"/>
                    </list>
                    <body>
                        <empty>
                            <var-def name="pageCopiesUrl">
                                <template>${sys.fullUrl(pageUrl.toString(), url.toString())}</template>
                            </var-def>
                            <file action="write" path="pageCopiesUrl.html">
                                <var name="pageCopiesUrl"/>
                            </file>
                        </empty>
                        <call name="copies-list">
                            <call-param name="pageUrl">
                                <var name="pageCopiesUrl"/>
                            </call-param>
                            <call-param name="itemXPath">
                                <var name="itemXPath"/>
                            </call-param>
                        </call>
                    </body>
                </loop>
            </while>
        </return>
    </function>
</config>